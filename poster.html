<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script defer src="/_vercel/insights/script.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <title>Poster</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="This generator allows you to instantly create posters for any music album for absolutely free!">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue",sans-serif;
        }

        .main {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        .options-div {
            float: left;
            width: 50%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background-color: #ffffff;
        }

        .options-div form {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-right: 50px;
        }

        .poster-div {
            float: right;
            width: 50%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgb(15, 20, 30);
            overflow-y: scroll;
        }

        #image-res {
            color: #ffffff;
            font-size: 20px;
            margin-top: 20px;
        }

        #image-display {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow-y: scroll;
        }

        #image-display img {
            aspect-ratio: 0.75;
            height: 650px;
        }

        #image-display button {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            color: rgb(15, 20, 30);
            background-color: #ffffff;
            font-size: 20px;
            cursor: pointer;
            margin-top: 20px;
        }

        #image-display button:hover {
            background-color: rgb(240, 240, 240);
        }

        .lds-ellipsis {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }

        .lds-ellipsis div {
            position: absolute;
            top: 33px;
            width: 13px;
            height: 13px;
            border-radius: 50%;
            background: #ffffff;
            animation-timing-function: cubic-bezier(0, 1, 1, 0);
        }

        .lds-ellipsis div:nth-child(1) {
            left: 8px;
            animation: lds-ellipsis1 0.6s infinite;
        }

        .lds-ellipsis div:nth-child(2) {
            left: 8px;
            animation: lds-ellipsis2 0.6s infinite;
        }

        .lds-ellipsis div:nth-child(3) {
            left: 32px;
            animation: lds-ellipsis2 0.6s infinite;
        }

        .lds-ellipsis div:nth-child(4) {
            left: 56px;
            animation: lds-ellipsis3 0.6s infinite;
        }

        @keyframes lds-ellipsis1 {
            0% {
                transform: scale(0);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes lds-ellipsis3 {
            0% {
                transform: scale(1);
            }
            100% {
                transform: scale(0);
            }
        }

        @keyframes lds-ellipsis2 {
            0% {
                transform: translate(0, 0);
            }
            100% {
                transform: translate(24px, 0);
            }
        }

        #generate-div {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        #generate-div button {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            background-color: rgb(15, 20, 30);
            color: #ffffff;
            font-size: 20px;
            cursor: pointer;
        }

        .dark-mode {
            background-color: #333;
            color: #fff;
        }

        .dark-mode .options-div {
            background-color: #444;
        }

        .dark-mode .poster-div {
            background-color: #222;
        }

        .dark-mode #image-display button {
            background-color: #444;
            color: #fff;
        }

        .dark-mode #image-display button:hover {
            background-color: #555;
        }
    </style>
</head>
<body>
    <div class="main">
        <div class="options-div">
            <form>
                <label for="album-name">Album Name</label>
                <input id="album-name" />
                <label for="album-year">Album Year</label>
                <input id="album-year" />
                <label for="album-artist">Album Artist</label>
                <input id="album-artist" />
                <label for="copyright">Display copyright info?</label>
                <input type="checkbox" id="copyright">
                <label for="tracklist">Tracklist</label>
                <div id="tracklist">
                    <div class="tracklist-item">
                        <input class="tracklist-item-name" />
                        <input class="tracklist-item-duration" />
                    </div>
                </div>
                <label for="dark-mode">Dark Mode</label>
                <input type="checkbox" id="dark-mode" onchange="toggleDarkMode()">
            </form>

            <div id="generate-div">
                <button type="button" onclick="generatePoster()">Generate Poster</button>
            </div>
        </div>
        <div class="poster-div">
            <div id="image-display" style="display: none;">
                <img id="poster-display" src="" alt="Poster" />
                <span id="image-res">Resolution: </span>
                <button type="button" onclick="saveImage()">Save Image</button>
            </div>
            <div id="loader" style="display: none">
                <div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        let url = new URL(window.location.href);
        let collectionId = url.searchParams.get("id");

        let data = null;

        fetch(`https://itunes.apple.com/lookup?id=${collectionId}&entity=song`)
            .then(response => response.json())
            .then(res => {
                data = res;

                // Change page title
                document.title = `${data.results[0].collectionName} Poster`;

                // Change meta description
                document.querySelector("meta[name='description']").content = `Generated poster for ${data.results[0].collectionName} by ${data.results[0].artistName}`;

                // Populate form
                document.getElementById("album-name").value = data.results[0].collectionName;
                document.getElementById("album-year").value = data.results[0].releaseDate.substring(0, 4);
                document.getElementById("album-artist").value = data.results[0].artistName;

                // Populate tracklist
                let tracklist = document.getElementById("tracklist");
                tracklist.innerHTML = "";
                for (let i = 1; i < data.results.length; i++) {
                    let track = data.results[i];
                    let tracklistItem = document.createElement("div");
                    tracklistItem.classList.add("tracklist-item");
                    tracklistItem.innerHTML = `
                        <input class="tracklist-item-name" value="${track.trackName}" />
                        <input class="tracklist-item-duration" value="${new Date(track.trackTimeMillis).toISOString().substr(14, 5)}" />
                    `;
                    tracklist.appendChild(tracklistItem);
                }

                // Generate poster
                generatePoster();
            })
            .catch(error => {
                console.error(error);
            });

        const toMilliseconds = (hrs,min,sec) => (hrs*60*60+min*60+sec)*1000;

        function generatePoster() {
            // Validate tracklist using regex
            var tracklist = Array.from(document.querySelectorAll(".tracklist-item"));
            let tracklistValid = true;
            tracklist.forEach(item => {
                let index = tracklist.indexOf(item);
                let duration = item.querySelector(".tracklist-item-duration").value;
                let name = item.querySelector(".tracklist-item-name").value;
                if (!name && !duration) {
                    // if no name and duration found, item removed from list
                    tracklist.splice(index, 1);
                } else if (!/^\d{2}:\d{2}$/.test(duration)) {
                    tracklistValid = false;
                    Toastify({
                        text: `Track ${index} duration must be in the format mm:ss`,
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "linear-gradient(to right, #ff0000, #ff0000)",
                        stopOnFocus: true
                    }).showToast();
                } else if (!name) {
                    tracklistValid = false;
                    Toastify({
                        text: `Track ${index}\'s name missing`,
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "linear-gradient(to right, #ff0000, #ff0000)",
                        stopOnFocus: true
                    }).showToast();
                };
            });

            if (!tracklistValid) {
                return;
            }

            // Show loader
            document.getElementById("loader").style.display = "block";

            // Clear image
            document.getElementById("image-display").style.display = "none";

            // Calculate optimal number of columns
            let numTracks = tracklist.length;
            let numColumns = Math.ceil(numTracks / 3);
            let tracksPerColumn = Math.ceil(numTracks / numColumns);

            // Generate poster image
            let canvas = document.createElement("canvas");
            let ctx = canvas.getContext("2d");
            canvas.width = 800;
            canvas.height = 1200;

            // Set background color
            let darkMode = document.getElementById("dark-mode").checked;
            ctx.fillStyle = darkMode ? "#333" : "#fff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw album details
            ctx.fillStyle = darkMode ? "#fff" : "#000";
            ctx.font = "24pt Arial";
            ctx.fillText(document.getElementById("album-name").value, 20, 50);
            ctx.font = "12pt Arial";
            ctx.fillText(document.getElementById("album-year").value, 20, 80);
            ctx.fillText(document.getElementById("album-artist").value, 20, 110);

            // Draw tracklist
            ctx.font = "12pt Arial";
            let x = 20;
            let y = 150;
            for (let i = 0; i < tracklist.length; i++) {
                let track = tracklist[i];
                let trackName = track.querySelector(".tracklist-item-name").value;
                let trackDuration = track.querySelector(".tracklist-item-duration").value;
                ctx.fillText(`${trackName} (${trackDuration})`, x, y);
                y += 30;
                if ((i + 1) % tracksPerColumn === 0) {
                    x += 200;
                    y = 150;
                }
            }

            // Display poster image
            let poster = document.getElementById("poster-display");
            poster.src = canvas.toDataURL();
            document.getElementById("image-display").style.display = "flex";
            poster.onload = () => {
                document.getElementById("image-res").innerHTML = `Resolution: ${poster.naturalWidth}x${poster.naturalHeight}`;
            };

            // Hide loader
            document.getElementById("loader").style.display = "none";
        }

        function saveImage() {
            let image = document.querySelector("#image-display img");
            let link = document.createElement("a");
            link.href = image.src;
            link.download = "poster.png";
            link.click();
        }

        function toggleDarkMode() {
            document.body.classList.toggle("dark-mode");
        }
    </script>
</body>
</html>
